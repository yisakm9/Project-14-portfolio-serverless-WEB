name: Production Deployment Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'backend/**'
      - 'frontend/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.13.1
  WORKING_DIR: ./terraform/environments/dev
  # Frontend Config Paths
  SSM_API_URL_PATH: "/yisak-portfolio/dev/api_url"
  SSM_BUCKET_PATH: "/yisak-portfolio/dev/frontend_bucket"
  SSM_CLOUDFRONT_PATH: "/yisak-portfolio/dev/cloudfront_id"

permissions:
  id-token: write
  contents: read

jobs:
  # ------------------------------------------------------------------
  # JOB 1: CHANGE DETECTION
  # Checks which folders were modified in this commit
  # ------------------------------------------------------------------
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'terraform/**'
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # ------------------------------------------------------------------
  # JOB 2: INFRASTRUCTURE & BACKEND (Terraform)
  # Runs if Terraform OR Backend Python code changes
  # ------------------------------------------------------------------
  deploy-infra:
    needs: detect-changes
    # Run if 'infra' filter matched OR if manually triggered
    if: ${{ needs.detect-changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch' }}
    name: Deploy Infra & Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActionsInfraSession

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve

  # ------------------------------------------------------------------
  # JOB 3: FRONTEND (React)
  # Runs if Frontend code changes
  # ------------------------------------------------------------------
  deploy-frontend:
    needs: [detect-changes, deploy-infra]
    # Logic: Run if Frontend changed AND (Infra Succeeded OR Infra was Skipped)
    if: ${{ always() && needs.detect-changes.outputs.frontend == 'true' && (needs.deploy-infra.result == 'success' || needs.deploy-infra.result == 'skipped') }}
    name: Deploy Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActionsFrontendSession

      # --- 1. DYNAMIC FETCH STEP ---
      - name: Fetch Dynamic Config from SSM
        id: fetch-config
        run: |
          echo "Fetching latest configuration from AWS..."
          
          # Fetch API URL
          API_URL=$(aws ssm get-parameter --name "${{ env.SSM_API_URL_PATH }}" --query "Parameter.Value" --output text)
          echo "DETECTED_API_URL=$API_URL" >> $GITHUB_ENV
          
          # Fetch Bucket & CloudFront
          BUCKET=$(aws ssm get-parameter --name "${{ env.SSM_BUCKET_PATH }}" --query "Parameter.Value" --output text)
          echo "S3_BUCKET_NAME=$BUCKET" >> $GITHUB_ENV
          
          DIST_ID=$(aws ssm get-parameter --name "${{ env.SSM_CLOUDFRONT_PATH }}" --query "Parameter.Value" --output text)
          echo "CLOUDFRONT_DIST_ID=$DIST_ID" >> $GITHUB_ENV

      # --- 2. DEBUG STEP (Optional but recommended) ---
      - name: Debug Variables
        run: |
          echo "Using API URL: ${{ env.DETECTED_API_URL }}"
          echo "Using Bucket: ${{ env.S3_BUCKET_NAME }}"

      # --- 3. BUILD STEP WITH EXPLICIT INJECTION ---
      - name: Build Production Bundle
        run: npm run build
        env:
          # This forces Vite to use the URL we just fetched from AWS
          VITE_API_URL: ${{ env.DETECTED_API_URL }}

      - name: Sync to S3
        run: |
          aws s3 sync ./dist s3://${{ env.S3_BUCKET_NAME }} --delete --cache-control "max-age=31536000,public"

      - name: Invalidate CloudFront Cache
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_DIST_ID }} --paths "/*"